---
layout: post
title: virtio-blk简介
description: virtio-blk简介
category: 技术
---

virtio-blk是虚拟化KVM平台下虚拟磁盘的一种实现方式，也是存储虚拟化所研究的主要对象之一。在KVM平台下，qemu程序负责模拟一台PC的整个工作过程，是虚拟化技术的精髓所在。大家知道，在物理PC中，磁盘是必不可少的设备，系统、应用程序的安装和数据的存放都离不开磁盘。在虚拟化场景下，qemu自然也需要提供对磁盘的模拟。那qemu到底是如何模拟磁盘的？virtio-blk又是一种什么样的虚拟磁盘呢？

qemu对设备的模拟可以分成两类：全模拟和半模拟。全模拟即完全模拟物理设备的工作过程，使得运行在虚拟机上的软件完全感知不到自身运行环境的差异。例如qemu中实现了对IDE磁盘、LSI控制器(其上可接SCSI磁盘)等物理存储设备的模拟，原先运行在物理机上的IDE驱动、LSI驱动或应用程序不做任何改动即可运行在虚拟机中。因此，全模拟的优点比较明显，即不用提供专门针对虚拟化场景的设备驱动，完全可以复用物理环境下的驱动程序。那么全模拟有何缺点呢？全模拟时，虚拟机内部驱动会频繁访问虚拟机IO端口，KVM平台下会导致大量的陷入和陷出操作；另外虚拟机内外数据传输时只能通过以字节为单位的拷贝方式进行，无法直接采用共享内存的方式，因此存在较大的访问性能问题。

为解决全虚拟化在性能上的问题，半模拟技术应运而生。它构造了一种虚拟化环境所独有的存储设备，因此需要在虚拟机内部安装特定的驱动程序才能正常驱使该设备进行工作。通常我们称虚拟机内部的驱动为前端驱动，称负责实现其功能模拟的程序(KVM平台下即为qemu程序)为后端程序，半模拟技术也常常被叫做前后端技术。采用半摸拟技术后，配合前端驱动，虚拟化设备完全可以采用全新的事件通知和数据传递机制进而大幅提升性能，例如在virtio-blk磁盘中，采用io_event_fd进行前端到后端通知，采用中断注入方式实现后端到前端的通知，并通过IO环(vring)进行数据的共享。

至此，主要说明了virtio-blk产生的背景及其价值。附上qemu所模拟的PC(基于intel i440fx主板架构)的组成结构图，以作为后续深入分析的基础。  
![](/images/2014-11-17-virtio-blk/1.jpg)

qemu模拟实现的virtio-blk设备的组成结构如下图所示：  
![](/images/2014-11-17-virtio-blk/2.jpg)

从图中可见，virtio-blk设备“内嵌”在一块PCI设备板(即virtio-blk-pci设备)上，其内部通过一条virtio总线连接PCI接口和virtio-blk设备。为何要将virtio-blk设备设计成这样呢？

qemu模拟的所有设备都通过总线相连，总线下可挂接若干设备，桥接设备又可生成子总线；整个PC只有一条根总线(即Main System Bus，对应前端总线FSB)。因此，qemu内模拟的所有设备构成一棵总线与设备交替衍生的树。virito-blk是一种什么样的设备？又该连接在什么总线上呢？虽然virtio-blk仅在虚拟化环境下存在，但如果完全凭空创造一种新的设备类型，那前端驱动开发将是一个很大的挑战。PCI设备是PC中最为常见的一种设备类别，且有较为完善的规范说明，因此可将virtio-blk设备模拟成一种PCI设备，这样可复用虚拟机内部已有的PCI驱动。

virtio-blk设备从功能上来看，核心功能就是实现虚拟机内外的事件通知和数据传递：虚拟机内部的前端驱动准备好待处理的IO请求和数据存放空间并通知后端；虚拟机外部的后端程序获取待处理的请求并交给真正的IO子系统处理，完成后将处理结果通知前端。实际上，除了虚拟磁盘，虚拟网卡也完全可以复用这套机制，从而实现半模拟的网络前后端(virtio-net)。如果将virtio-blk或virtio-net设计成不同类型的PCI设备，那么前端驱动中会存在大量关于事件通知和数据传递的重复代码。

综上分析，virtio-blk首先是PCI设备；其次为了复用半模拟中通用的事件通知和数据传递机制，抽象出一类virtio-pci设备，其内部通过virtio总线连接不同的virtio设备。这样virtio-blk设备就通过virtio总线连接到virtio-blk-pci设备的PCI接口上，virtio-net也通过virtio总线连接到virtio-net-pci设备的PCI接口上。可能有的人会问，为何通过设备的抽象就能复用前端驱动的代码？在virtio-blk-pci或virtio-net-pci前端驱动加载时，最初识别到的都是virtio-pci设备，这样都可调用virtio-pci驱动进行事件通知和数据传递的初始化，后续也可使用virtio-pci中相关函数进行事件通知和数据传递。

因此virtio-blk完全是基于通用的virtio框架实现的磁盘前后端，virtio框架中最为核心的就是事件通知和数据传递机制。